name: Run .NET API Integration Tests

on:
  push:
    branches:
        - '*'
  pull_request:
    branches:
        - '*'
  schedule:
      - cron: '0 0 1 * *' # Runs at midnight on the first day of every month 
  workflow_dispatch:

permissions:
  checks: write
  pull-requests: write
  contents: read
  security-events: write

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20.x'
  BUILD_CONFIGURATION: Release

jobs:
  dotnet-tests:
    name: .NET Integration Tests
    uses: ./.github/workflows/dotnet-tests.yml
    with:
      dotnet-version: '9.0.x'
      build-configuration: 'Release'
    permissions:
      checks: write
      contents: read

  postman-tests:
    name: Postman API Tests
    needs: dotnet-tests
    if: always()
    uses: ./.github/workflows/postman-tests.yml
    with:
      node-version: '20.x'
    permissions:
      contents: read

  security-scan:
    name: Security Scan (ZAP)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    uses: ./.github/workflows/security-scan.yml
    with:
      target-url: 'https://api.restful-api.dev/'
      fail-on-issues: false
    permissions:
      contents: read
      security-events: write
    secrets: inherit

  test-summary:
    name: Test Summary
    needs: [dotnet-tests, postman-tests, security-scan]
    if: always()
    uses: ./.github/workflows/test-summary.yml
    with:
      dotnet-result: ${{ needs.dotnet-tests.result }}
      postman-result: ${{ needs.postman-tests.result }}
      security-result: ${{ needs.security-scan.result }}
      workflow-status: 'completed'
    permissions:
      contents: read